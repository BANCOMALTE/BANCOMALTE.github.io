<html>
    <head>
        <title>AllScan</title>
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <font color="blue"><p>BENVENUTO SU ALLSCAN</p></font>
<img src="logo.jpg" align="top" width="200" height="200">
        <link rel="icon" href="/favicon.ico" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://tiles.unwiredmaps.com/js/leaflet-unwired.js"></script>
    <script src="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet/0.0.1-beta.5/esri-leaflet.js"></script>
    <script src="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet-geocoder/0.0.1-beta.5/esri-leaflet-geocoder.js"></script>
     <link rel="stylesheet" type="text/css" href="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet-geocoder/0.0.1-beta.5/esri-leaflet-geocoder.css">   
        <style>
        #map { height: 560px; width: 100%; }
        body { margin:20px; padding:20px; }
    </style>
        <style> 
.card { min-width: 200px }
</style>
        
        
    <script>

    /* 

            Tramite queste variabili è possibile personalizzare i parametri della query che verrà effettuata

            token (string): token Unwired Labs
            radio (string): tecnologia radio
            mcc (int): codice paese
            mnc (int): codice operatore
            lac (int): location area code (default: 1)
            cid (int): cell id da richiedere al servizio
            psc (int): primary scrambling code (default: 0)
            address (boolean): impostare a 1 per richiedere anche l'indirizzo, altrimenti 0

    */

    function AllScan() {
        var token = $("#token").val(),
            radio = $("#radio").val(),
            mcc = $("#mcc").val(),
            mnc = $("#mnc").val(),
            lac = 1,
            startcid = $("#startcid").val(),
            stopcid = $("#stopcid").val(),
            enodeb = $("#enodeb").val(),
            carrier = $("#carrier").val(),
            psc = 0,
            address = 1;

        if(stopcid >= startcid || (enodeb != "" && enodeb > 0)){
            if(enodeb != "" && enodeb > 0){
           if(carrier == "w3"){
                startcid = enodeb * 256;
                stopcid = enodeb * 256 + 21;
              
                }else if (carrier == "vf") {
                startcid = enodeb * 256 + 11;
                stopcid = enodeb * 256 + 54;
                 } else if(carrier == "timHUAWEI") { startcid = enodeb * 256;
                    stopcid = enodeb * 256 + 39;
                
                 } else if(carrier == "timHUAWEIB1"){
                     startcid = enodeb * 256 + 250;
                stopcid = enodeb * 256 + 253;
                     
                 } else if(carrier == "h3g") {    
             startcid = enodeb * 256 + 1;
                stopcid = enodeb * 256 + 6;
                      } else if(carrier == "iliad") {
                startcid = enodeb * 256 + 21;
                stopcid = enodeb * 256 + 83;  
                } else    {


                startcid = enodeb * 256 + 21;
                stopcid = enodeb * 256 + 64;
                 }}

            $("#result").html("");

            for(var cid = startcid; cid <= stopcid; cid++) {
                var request = {
                    "async": false,
                    "crossDomain": true,
                    "url": "https://eu1.unwiredlabs.com/v2/process.php",
                    "method": "POST",
                    "headers": {},
                    "processData": false,
                    "data": "{\"token\":" + token + ", \"radio\": " + radio + ", \"mcc\": " + mcc + ", \"mnc\": " + mnc + ", \"cells\": [{ \"lac\": " + lac + ", \"cid\": " + cid + ", \"psc\": " + psc + " }], \"address\": " + address + "}"
                }

                $.ajax(request).done(function (APIresponse) {
                    //se query ok
                    enodeb_c = parseInt(cid/256);
                    sec = cid - (enodeb_c * 256);

                    if(APIresponse.status == "ok") {
                         html = '<div class="card-group">';
                       html = '<div class="card col-2">';
                        html +=  "<b>MAPS:</b> <a href='http://maps.google.com/?q="+APIresponse.lat+","+APIresponse.lon+"' target='_blank'><button>MAPS</button></a>  <br />";
                        html += "<b>CID:</b> " + cid + "<br />";
                        html += "<b>ENODEB:</b> " + enodeb_c + "<br />";
                        html += "<b>SECTOR:</b> " + sec + "<br />";
                        html += "<b>ACCURACY:</b> " + APIresponse.accuracy + "<br />";
                         html += "<b>ADDRESS:</b> " + APIresponse.address + "<br />";
                        html += "<b>LAT:</b> " + APIresponse.lat + "<br />";
                        html += "<b>LON:</b> " + APIresponse.lon + "<br /><br />";
                        html += "</div>";

                        $("#result").append(html);
                        var marker = L.marker([ APIresponse.lat, APIresponse.lon]).addTo(map);
                        marker.bindPopup("<b>LAT:</b> " + APIresponse.lat + "<br /><b>LON:</b> " + APIresponse.lon + "<br /><b>CID:</b> " + cid + "<br /><b>ENODEB:</b> " + enodeb_c + "<br /><b>SECTOR:</b> " + sec + "<br />").openPopup();
                         marker.bindTooltip(enodeb_c + ":" + sec, {permanent: true, direction: 'bottom'}).openTooltip();
                        
                        
                        
                    }
                    //altrimenti, messaggio di errore
                    else {
                         html = '<div class="card col-2">';
                        html += "<b>CID:</b> " + cid + "<br />";
                        html += "<b>ENODEB:</b> " + enodeb_c + "<br />";
                        html += "<b>SECTOR:</b> " + sec + "<br />";
                        html += "<i>Not found</i> <br /><br />";
                        html += "</div>";

                        $("#result").append(html);
                    }
                });
            }
        }else {
            alert("Start CID must be <= than stop CID");
        }
    }

    </script>
</head>
<body>
    <div class="form-row">
    <div class="col">
    <div class="container-fluid pt-2">
        <input type="number" id="mcc" placeholder="MCC" required>
        <input type="number" id="mnc" placeholder="MNC" required>
        <input type="number" id="startcid" placeholder="Start CID" required>
        <input type="number" id="stopcid" placeholder="Stop CID" required>
        <input type="number" id="enodeb" placeholder="Enodeb" required>
        <input type="text" id="token" placeholder="Token" required>
        <select id="radio">
            <option value='"lte"'>LTE</option>
            <option value='"umts"'>UMTS</option>
            <option value='"gsm"'>GSM</option>
            
          </select>
        
        <select id="carrier">
            <option value= "vf" >VF</option>
            <option value= "timHUAWEI" >TIMHUAWEI</option>
            <option value= "timHUAWEIB1" >TIMHUAWEIB1</option>
            <option value= "tim" >TIMNOKIA</option>
            <option value= "h3g" >H3G ITALIA</option>
            <option value= "iliad" >ILIAD</option>
            <option value= "w3" >W3</option>
            
          </select>

        <button onclick="AllScan()">Go</button>

        <div id="result" class="row pt-2"></div>
    </div>
    </div>
    </div>
    <div id="map"></div>
    
    <script>





                    // API token goes here
var key = "9f2c971b2cd69c";

// Add layers that we need to the map
var streets = L.tileLayer.Unwired({key: key, scheme: "streets"});


// Initialize the map

var map = L.map('map', {
        center: [ 42.6197784,11.5083833 ], //map loads with this location as center
        zoom: 6,
        layers: [streets] // Show 'streets' by default
});





// Add the 'scale' control
L.control.scale().addTo(map);


var popup = L.popup();

    function onMapClick(e) {
        popup.setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(map);
    }

map.on('click', onMapClick);

var searchControl = new L.esri.Controls.Geosearch().addTo(map);

            var results = new L.LayerGroup().addTo(map);

              searchControl.on('results', function(data){
                results.clearLayers();
                for (var i = data.results.length - 1; i >= 0; i--) {
                  results.addLayer(L.marker(data.results[i].latlng));
                }
              });

        
         const maps = [streets]; 
        const resetcontrol = L.Control.extend({

    options: {
        position: 'topleft'
    },
    onAdd: function () {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        container.style.cursor= 'pointer';
        container.innerHTML = '<a class="darkmodetoggle"><i class="material-icons">delete</i></a>';

        container.onclick = function () {
          map.eachLayer(function (layer) {
            if(!maps.includes(layer))
              map.removeLayer(layer);
          });
        };
        return container;
    },

});
map.addControl(new resetcontrol);
        </script>
</body>
</html>
